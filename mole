#!/bin/bash
#xpodra03 Jiri Podrazil

POSIXLY_CORRECT=yes

export POSIXLY_CORRECT=yes
export LC_NUMERIC=en_US.UTF-8


print_help()
{
    echo -e "Usage: \tmole -h"
    echo -e "\tmole [-g GROUP] FILE"
    echo -e "\t\tFILE will be open by yourEditor. Defaul is vim"
    echo -e "\tmole [-m] [FILTERS] [DIRECTORY]"
    echo -e "\t\t"
    echo -e "\tmole list [FILTERS] [DIRECTORY]:"

    echo -e ""
    echo -e "\texport MOLE_RC=yourFILE"
    echo -e "\t\tYou need to set file, where the record will be saved"

    echo -e ""
    echo -e "\texport EDITOR=yourEditor"
    echo -e "\t\tYou can change the editor. Defaul is vim"


    echo -e "\t"
    echo -e "\texport MOLE_RC=yourFILE"
    echo -e "\t\tYou need to set file, where the record will be saved"
    
    if [ "$LOG_FILES" == "" ]; then       #
        LOG_FILES="Have not been set yet"    
    fi
    echo -e "\t\tCurrent record file is:\t$LOG_FILES"
    if [ "$LOG_FILES" == "Have not been set yet" ]; then       #
        LOG_FILES=""    
    fi


    echo $LOG_FILES
}


FILTER=""
DATE=$(date +%F)
LOG_FILES=$MOLE_RC  #
EDIT=$EDITOR        #default EDITOR is vim. User can change it by this variable
DATE_A="0000-00-00"           #records after this date. others are ignored
DATE_B="9999-99-99"           #records before this date. others are ignored
FILE=""             #file that user want open
DIRECTORY=""        #directory where user want open file
GROUP=""            #variable for file GROUP 
COMMAND=""          #varialble for command (list, secret-log)

while [ "$#" -gt 0 ]; do
    case "$1" in
    -h)
        print_help
        exit 0
        ;;
    -a)
        DATE_A="$2"
        shift
        shift
        ;;
    -b)
        DATE_B="$2"
        shift
        shift
        ;;
    -g)
        GROUP="$2"
        shift
        shift
        ;;
    -m)     #DOTO
        GROUP="$2"
        shift
        shift
        ;;
    *)                              
        if [ -z "$COMMAND" ];then         
            COMMAND="$1"
            shift
        else                      
            exit 1
        fi
        ;;
    esac
done




if [ "$COMMAND" == "list" ]; then       #
    
    #print file with records
    #DOTO
    awk -F, -v GROUP=$GROUP -v DATE_A=$DATE_A -v DATE_B=$DATE_B '((GROUP == $2|| GROUP == "")&&($3>DATE_A)&&($3<DATE_B)) {print $1"\t"$2}' $MOLE_RC
    #awk -F, -v DATE_A=$DATE_A -v DATE_B=$DATE_B -v GROUP=$GROUP -v FILE=$LOG_FILES'NR > 0 && (($2 == GROUP || GENDER == "")){ print("FILE: \tGROUP") }
    #        END{}' "$MOLE_RC"
    #cat $MOLE_RC
    #echo "jeste neni hotovo"
    
fi

if [ "$COMMAND" == "secret-log" ]; then         #
    #secret-log DOTO
    echo "jeste neni hotovo"
fi


# commant is not "list" or "sec-log", so it has to by file, or file dicertory
if [ "$COMMAND" != "list" ] && [ "$COMMAND" != "secret-log" ] && [ "$COMMAND" != "" ]; then
    
    echo -e ".$COMMAND:,$GROUP,$DATE" >> $MOLE_RC  #make record about opening file

    if [ "$EDIT" != "vim" ] && [ "$EDIT" != "" ]; then
        #not dafault editor
        echo $EDIT
        $EDIT $COMMAND
              

    else
        vi $COMMAND     ##dafaul editor is vim   
    fi
fi

exit
